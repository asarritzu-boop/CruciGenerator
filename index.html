<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRUCIVERBA GENERATOR</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1C1C1E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icona-512.png">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://asarritzu-boop.github.io/CruciGenerator/">
    <meta property="og:title" content="Cruciverba Generator Biblico">
    <meta property="og:description" content="Crea i tuoi schemi biblici personalizzati. Funziona anche offline.">
    <meta property="og:image" content="https://asarritzu-boop.github.io/CruciGenerator/icona-512.png">

    <script src="glossario.js"></script>
    
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-gray: #8E8E93;
            --ios-light-gray: #E5E5EA;
            --ios-bg: #000000;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            height: 100vh; width: 100vw; 
            display: flex; flex-direction: column; 
            background: var(--ios-bg); overflow: hidden;
            color: white;
        }

        header {
            height: 35px; background: #1C1C1E;
            display: flex; align-items: center; justify-content: center;
            border-bottom: 0.5px solid #333; flex-shrink: 0;
        }
        header h1 { font-size: 11px; font-weight: 600; color: var(--ios-gray); text-transform: uppercase; letter-spacing: 0.8px; }

        #main-container {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 10px; gap: 5px;
        }

        #grid { 
            display: grid; 
            grid-template-columns: repeat(11, 1fr); 
            grid-template-rows: repeat(11, 1fr); 
            gap: 1px; background: #3A3A3C; 
            border: 2px solid #3A3A3C;
            border-radius: 8px; overflow: hidden;
            width: min(95vw, calc(100vh - 150px)); 
            height: min(95vw, calc(100vh - 150px));
        }

        .cell { 
            background: #FFF; display: flex; align-items: center; justify-content: center; 
            font-weight: 700; font-size: min(5vw, 3.5vh); cursor: pointer; 
            position: relative; text-transform: uppercase; color: #000;
        }
        .cell.black { background: #1C1C1E; }
        .cell .num { 
            position: absolute; top: 1px; left: 2px; 
            font-size: min(1.8vw, 1.1vh); color: var(--ios-gray); font-weight: 600; 
        }

        .footer-controls { 
            display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0;
            width: min(95vw, calc(100vh - 150px));
        }
        .btn { 
            flex: 1; min-width: 60px; height: 46px; border: none; border-radius: 12px;
            color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
        }
        .btn:active { opacity: 0.7; transform: scale(0.96); }
        .btn-reset { background: var(--ios-red); }
        .btn-export { background: var(--ios-blue); }
        .btn-share { background: var(--ios-green); }
        .btn-undo { background: #444; }

        @media (orientation: landscape) {
            #main-container { flex-direction: row; gap: 20px; }
            #grid { width: calc(100vh - 60px); height: calc(100vh - 60px); }
            .footer-controls { flex-direction: column; width: 140px; height: calc(100vh - 60px); justify-content: center; }
            .btn { flex: 0 0 46px; width: 100%; }
        }

        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 100; }
        #modal { 
            display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: #FFF; padding: 20px; border-radius: 20px; z-index: 101; 
            width: 92%; max-width: 440px; color: #000;
            box-shadow: 0 15px 50px rgba(0,0,0,0.9);
        }

        .modal-grid-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .mode-btn { padding: 14px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 13px; }
        .btn-black-toggle { background: #3A3A3C; color: white; }
        .btn-dir { background: var(--ios-blue); color: white; }
        .btn-clear { background: var(--ios-light-gray); color: var(--ios-red); grid-column: span 2; }

        #manual-input { 
            background: #F2F2F7; padding: 12px; border-radius: 12px; margin-bottom: 15px;
            display: none; flex-direction: column; gap: 8px;
        }
        #manual-input input { 
            padding: 10px; border: 1px solid #CCC; border-radius: 8px; font-size: 14px; 
        }
        #mAddBtn { background: var(--ios-green); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 700; }

        .s-item { 
            padding: 15px; border-bottom: 0.5px solid var(--ios-light-gray); width: 100%; 
            text-align: left; background: none; border: none; cursor: pointer; 
        }
        .s-item strong { color: var(--ios-blue); font-size: 17px; }
        .s-item.used strong { color: var(--ios-red); }
        .s-item small { color: #333; font-size: 12px; display: block; margin-top: 3px; }
        .no-match { text-align: center; padding: 30px 10px; color: var(--ios-gray); font-weight: 500; }
    </style>
</head>
<body>

<header><h1>Cruciverba Generator</h1></header>

<div id="main-container">
    <div id="grid"></div>
    
    <div class="footer-controls">
        <button class="btn btn-undo" onclick="undo()" title="Annulla">↩</button>
        <button class="btn btn-undo" onclick="redo()" title="Ripristina">↪</button>
        <button class="btn btn-reset" onclick="resetAll()">Nuovo</button>
        <button class="btn btn-export" onclick="exportJS()">Esporta</button>
        <button class="btn" style="background: var(--ios-gray);" onclick="document.getElementById('importFile').click()">Importa</button>
        <button class="btn btn-share" onclick="shareApp()">Condividi</button>
        <input type="file" id="importFile" accept=".js" style="display:none" onchange="importJS(this)">
    </div>
</div>

<div id="overlay" onclick="closeM()"></div>
<div id="modal">
    <div id="modal-actions" class="modal-grid-btns"></div>
    
    <div id="manual-input">
        <input type="text" id="mWord" placeholder="PAROLA" style="text-transform: uppercase;">
        <input type="text" id="mDef" placeholder="DEFINIZIONE">
        <button id="mAddBtn">INSERISCI MANUALE</button>
    </div>

    <div id="sList" style="max-height: 40vh; overflow-y: auto; -webkit-overflow-scrolling: touch;"></div>
</div>

<script>
    const S = 11;
    let data = Array(S).fill().map(() => Array(S).fill(null).map(() => ({ l: '', b: false, n: 0, mH: null, mV: null })));
    let cur = { x: 0, y: 0 };
    
    // Logica Undo/Redo
    let undoStack = [];
    let redoStack = [];

    function saveState() {
        undoStack.push(JSON.stringify(data));
        redoStack = [];
    }

    function undo() {
        if (undoStack.length === 0) return;
        redoStack.push(JSON.stringify(data));
        data = JSON.parse(undoStack.pop());
        render();
    }

    function redo() {
        if (redoStack.length === 0) return;
        undoStack.push(JSON.stringify(data));
        data = JSON.parse(redoStack.pop());
        render();
    }

    window.addEventListener('load', () => {
        render();
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
        }
    });

    function updateNumbers() {
        data.forEach(r => r.forEach(c => c.n = 0));
        let count = 1;
        for (let y = 0; y < S; y++) {
            for (let x = 0; x < S; x++) {
                if (data[y][x].b) continue;
                let h = (x === 0 || data[y][x-1].b) && (x + 1 < S && !data[y][x+1].b);
                let v = (y === 0 || data[y-1][x].b) && (y + 1 < S && !data[y+1][x].b);
                if (h || v) data[y][x].n = count++;
            }
        }
    }

    function render() {
        updateNumbers();
        const g = document.getElementById('grid');
        g.innerHTML = '';
        data.forEach((row, y) => row.forEach((c, x) => {
            const d = document.createElement('div');
            d.className = 'cell' + (c.b ? ' black' : '');
            if (!c.b) {
                if (c.n > 0) d.innerHTML += `<span class="num">${c.n}</span>`;
                d.innerHTML += `<span>${c.l}</span>`;
            }
            d.onclick = () => { cur = {x, y}; openM(); };
            g.appendChild(d);
        }));
    }

    function openM() { 
        const cell = data[cur.y][cur.x];
        const actions = document.getElementById('modal-actions');
        document.getElementById('sList').innerHTML = '';
        document.getElementById('manual-input').style.display = 'none';
        
        actions.innerHTML = `
            <button class="mode-btn btn-black-toggle" onclick="toggleBlack()">
                ${cell.b ? 'RENDI BIANCA' : 'RENDI NERA'}
            </button>
            <button class="mode-btn btn-dir" onclick="findWords('H')">ORIZ</button>
            <button class="mode-btn btn-dir" onclick="findWords('V')">VERT</button>
            <button class="mode-btn btn-clear" onclick="clearCell()">SVUOTA CASELLA</button>
        `;

        document.getElementById('overlay').style.display = 'block'; 
        document.getElementById('modal').style.display = 'block'; 
    }
    
    function closeM() { 
        document.getElementById('overlay').style.display = 'none'; 
        document.getElementById('modal').style.display = 'none'; 
    }

    function toggleBlack() {
        saveState();
        data[cur.y][cur.x].b = !data[cur.y][cur.x].b;
        if (data[cur.y][cur.x].b) clearCellData(cur.x, cur.y);
        render(); closeM();
    }

    function clearCell() {
        saveState();
        clearCellData(cur.x, cur.y);
        data[cur.y][cur.x].b = false;
        render(); closeM();
    }

    function clearCellData(x, y) {
        data[y][x].l = '';
        data[y][x].mH = null;
        data[y][x].mV = null;
    }

    function findWords(dir) {
        let pat = "", len = 0;
        for (let i = 0; (dir === 'H' ? cur.x + i : cur.y + i) < S; i++) {
            let cell = dir === 'H' ? data[cur.y][cur.x + i] : data[cur.y + i][cur.x];
            if (cell.b) break;
            pat += cell.l || ".";
            len++;
        }

        const list = document.getElementById('sList');
        const manualDiv = document.getElementById('manual-input');
        list.innerHTML = '';
        manualDiv.style.display = 'flex';

        document.getElementById('mAddBtn').onclick = () => {
            let w = document.getElementById('mWord').value.toUpperCase().trim();
            let d = document.getElementById('mDef').value.trim();
            if (w.length >= 2 && w.length <= len && d !== "") {
                insertWord(w, d, dir, len);
            } else {
                alert("Parola non valida (min 2 lettere, max " + len + ") o definizione mancante.");
            }
        };

        if (!window.glossarioData) return;

        let usedWords = [];
        data.forEach(r => r.forEach(c => {
            if(c.mH) usedWords.push(c.mH.w.toUpperCase());
            if(c.mV) usedWords.push(c.mV.w.toUpperCase());
        }));

        const matches = window.glossarioData.voci.filter(v => {
            let p = v.parola.toUpperCase();
            if (p.length >= 2 && p.length <= len && !["IL","LO","LA","LE","GLI","UN","UNO","UNA"].includes(p)) {
                let subPattern = pat.substring(0, p.length);
                return new RegExp(`^${subPattern}$`, "i").test(p);
            }
            return false;
        }).sort((a, b) => b.parola.length - a.parola.length);

        if (matches.length === 0) {
            list.innerHTML = '<div class="no-match">Nessuna corrispondenza nel glossario</div>';
        }

        matches.forEach(m => {
            const btn = document.createElement('button');
            let word = (m.parola.toUpperCase() === "LIA") ? "LEA" : m.parola.toUpperCase();
            let isUsed = usedWords.includes(word);
            
            btn.className = 's-item' + (isUsed ? ' used' : '');
            btn.innerHTML = `<strong>${word}</strong> ${isUsed ? '(GIÀ USATA)' : ''} <small>${m.def} (${m.rif})</small>`;
            btn.onclick = () => insertWord(word, `${m.def} (${m.rif})`, dir, len);
            list.appendChild(btn);
        });
    }

    function insertWord(word, definition, dir, maxLen) {
        saveState();
        if (word.length < maxLen) {
            let nx = dir === 'H' ? cur.x + word.length : cur.x;
            let ny = dir === 'H' ? cur.y : cur.y + word.length;
            if (nx < S && ny < S) {
                data[ny][nx].b = true;
                clearCellData(nx, ny);
            }
        }

        for (let i = 0; i < word.length; i++) {
            let cx = dir === 'H' ? cur.x + i : cur.x, cy = dir === 'H' ? cur.y : cur.y + i;
            data[cy][cx].l = word[i];
            data[cy][cx].b = false;
        }

        data[cur.y][cur.x][dir === 'H' ? 'mH' : 'mV'] = { 
            d: dir, x: cur.x, y: cur.y, w: word, c: definition 
        };
        
        document.getElementById('mWord').value = '';
        document.getElementById('mDef').value = '';
        render(); closeM();
    }

    async function shareApp() {
        const shareData = {
            title: 'Cruciverba Generator Biblico',
            text: 'Prova questa app per creare cruciverba biblici!',
            url: 'https://asarritzu-boop.github.io/CruciGenerator/'
        };
        try {
            if (navigator.share) await navigator.share(shareData);
            else {
                navigator.clipboard.writeText(shareData.url);
                alert("Link copiato negli appunti!");
            }
        } catch (err) { console.log(err); }
    }

    function exportJS() {
        const p = [];
        data.forEach((row, y) => row.forEach((c, x) => {
            if(c.mH) p.push({ n: c.n, d: 'H', x: x, y: y, w: c.mH.w, c: c.mH.c });
            if(c.mV) p.push({ n: c.n, d: 'V', x: x, y: y, w: c.mV.w, c: c.mV.c });
        }));

        let righeParole = p.map(item => {
            let defPulita = item.c.replace(/'/g, "\\'");
            return `            { n: ${item.n}, d: '${item.d}', x: ${item.x}, y: ${item.y}, w: '${item.w}', c: '${defPulita}' }`;
        }).join(',\n');

        const contenutoFile = `const SCHEMI_BIBLICI = [
    {
        id: 1,
        parole: [
\n${righeParole}
        ]
    }
];`;

        const blob = new Blob([contenutoFile], { type: 'text/javascript' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'schemi.js';
        a.click();
    }

    function resetAll() { 
        if(confirm("Cancellare tutto lo schema?")) { 
            saveState();
            data.forEach(r => r.forEach(c => { c.l=''; c.b=false; c.n=0; c.mH=null; c.mV=null; })); 
            render(); 
        } 
    }
    
    function importJS(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            
            // Regex più flessibile per trovare l'array delle parole
            const match = content.match(/parole:\s*\[([\s\S]*?)\]\s*\}\s*\]/);
            if (!match) {
                alert("Il file non sembra essere uno schema valido per questo generatore.");
                return;
            }

            // Pulizia e parsing delle singole voci
            const entries = match[1].split('},').filter(s => s.trim() !== '');
            const nuoveParole = entries.map(entry => {
                const getVal = (key) => {
                    // Cerca il valore tra virgolette o dopo i due punti
                    const regex = new RegExp(`${key}:\\s*['"]?([^'"]+)['"]?`);
                    const m = entry.match(regex);
                    return m ? m[1] : null;
                };

                const n = getVal('n');
                const d = getVal('d');
                const x = getVal('x');
                const y = getVal('y');
                const w = getVal('w');
                const c = getVal('c');

                if (!w) return null;

                return {
                    n: parseInt(n),
                    d: d,
                    x: parseInt(x),
                    y: parseInt(y),
                    w: w,
                    c: c ? c.replace(/\\'/g, "'") : ""
                };
            }).filter(p => p !== null);

            // SALVATAGGIO STATO PER UNDO
            saveState();

            // RESET GRIGLIA
            data.forEach(r => r.forEach(cell => { 
                cell.l=''; cell.b=false; cell.n=0; cell.mH=null; cell.mV=null; 
            }));

            // INSERIMENTO DATI
            nuoveParole.forEach(p => {
                // Posiziona metadati
                if (p.d === 'H') data[p.y][p.x].mH = p;
                else if (p.d === 'V') data[p.y][p.x].mV = p;
                
                // Forza numero
                data[p.y][p.x].n = p.n;

                // Scrive lettere
                for (let i = 0; i < p.w.length; i++) {
                    let cx = p.d === 'H' ? p.x + i : p.x;
                    let cy = p.d === 'H' ? p.y : p.y + i;
                    if (cx < S && cy < S) {
                        data[cy][cx].l = p.w[i].toUpperCase();
                        data[cy][cx].b = false;
                    }
                }
            });

            // LOGICA RIEMPIMENTO CASELLE NERE AUTOMATICHE
            for (let y = 0; y < S; y++) {
                for (let x = 0; x < S; x++) {
                    if (data[y][x].l === '') {
                        data[y][x].b = true;
                    }
                }
            }

            render();
            alert("Schema importato con successo!");
            
        } catch (err) {
            console.error("Errore Import:", err);
            alert("Errore tecnico durante l'importazione. Controlla la console.");
        }
        input.value = ''; // Reset input per permettere di ri-caricare lo stesso file
    };
    reader.readAsText(file);
}

</script>
</body>
</html>
