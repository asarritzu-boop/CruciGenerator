<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRUCIVERBA GENERATOR</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1C1C1E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icona-512.png">

    <script src="glossario.js"></script>
    
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-gray: #8E8E93;
            --ios-bg: #000000;
            --header-h: 40px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            height: 100vh; width: 100vw; 
            display: flex; flex-direction: column; 
            background: var(--ios-bg); overflow: hidden;
            color: white;
        }

        header {
            height: var(--header-h); background: #1C1C1E;
            display: flex; align-items: center; justify-content: center;
            border-bottom: 0.5px solid #333; flex-shrink: 0;
        }
        header h1 { font-size: 12px; font-weight: 600; color: var(--ios-gray); text-transform: uppercase; letter-spacing: 1px; }

        #main-container {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 10px; gap: 10px;
        }

        #grid { 
            display: grid; 
            grid-template-columns: repeat(11, 1fr); 
            grid-template-rows: repeat(11, 1fr); 
            gap: 1px; background: #3A3A3C; 
            border: 2px solid #3A3A3C;
            border-radius: 8px;
            width: min(95vw, calc(95vh - 160px));
            aspect-ratio: 1 / 1;
            flex-shrink: 0;
        }

        .cell { 
            background: #FFF; display: flex; align-items: center; justify-content: center; 
            font-weight: 700; font-size: 18px; cursor: pointer; 
            position: relative; text-transform: uppercase; color: #000;
        }
        .cell.black { background: #1C1C1E; }
        .cell .num { 
            position: absolute; top: 1px; left: 2px; 
            font-size: 9px; color: var(--ios-gray); font-weight: 600; 
        }

        .footer-controls { 
            display: flex; flex-direction: row; gap: 6px; 
            width: min(90vw, 450px); flex-shrink: 0;
        }
        .btn { 
            flex: 1; height: 40px; border: none; border-radius: 10px;
            color: #fff; font-size: 10px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-reset { background: var(--ios-red); }
        .btn-export { background: var(--ios-blue); }
        .btn-undo { background: #444; }

        /* MODALE TOTALMENTE SCROLLABILE */
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; }
        #modal { 
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: #FFF; border-radius: 20px; 
            z-index: 101; width: 95%; max-width: 500px; max-height: 90vh; 
            color: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            flex-direction: column; overflow: hidden;
        }

        #modal-scroll-area { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }

        .modal-grid-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .mode-btn { padding: 12px 2px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 10px; text-transform: uppercase; }
        .btn-black-toggle { background: #3A3A3C; color: white; }
        .btn-dir { background: var(--ios-blue); color: white; }

        #manual-input { background: #F2F2F7; padding: 10px; border-radius: 12px; margin-bottom: 15px; display: none; flex-direction: column; gap: 6px; }
        #manual-input input { padding: 10px; border: 1px solid #CCC; border-radius: 8px; font-size: 14px; width: 100%; }
        #mAddBtn { background: var(--ios-green); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 700; }

        #sList { border-top: 1px solid #EEE; padding-top: 10px; }
        .s-item { padding: 12px 0; border-bottom: 1px solid #F2F2F2; width: 100%; text-align: left; background: none; border: none; cursor: pointer; }
        .s-item strong { color: var(--ios-blue); font-size: 16px; display: block; }
        .s-item small { color: #555; font-size: 12px; line-height: 1.2; }

        @media (orientation: landscape) {
    /* 1. Elimina l'header e ogni margine inutile */
    header { display: none !important; }
    body { padding: 0 !important; margin: 0 !important; height: 100svh !important; }

    #main-container { 
        flex-direction: row !important; 
        padding: 2px 10px !important; 
        gap: 15px !important; 
        height: 100svh !important; /* Usa la Small Viewport Height */
        align-items: center;
        justify-content: center;
    }

    #grid { 
        /* Riduciamo drasticamente l'altezza per far apparire la riga 21 */
        height: 95svh !important; 
        width: 95svh !important; 
        max-width: 95vw !important;
        flex-shrink: 0;
        margin: 0 !important;
    }

    .footer-controls { 
        display: flex !important;
        flex-direction: column !important; 
        width: 90px !important; 
        /* I pulsanti devono essere alti quanto la griglia */
        height: 80svh !important; 
        justify-content: space-between !important; 
        gap: 2px !important;
        flex-shrink: 0;
    }

    .btn { 
        /* 'flex: 1' li rende "gonfi" se c'è spazio, quindi usiamo un'altezza fissa minima */
        flex: 1 !important;
        width: 100% !important;
        font-size: 8px !important;
        padding: 0 !important;
        min-height: 15px !important; /* Impedisce che spariscano */
        max-height: 35px !important; /* Impedisce che si "gonfino" troppo */
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px !important;
    }
}






    </style>
</head>
<body>

<header><h1>Cruciverba Generator</h1></header>

<div id="main-container">
    <div id="grid"></div>
    <div class="footer-controls">
        <button class="btn btn-undo" onclick="undo()">↩</button>
        <button class="btn btn-undo" onclick="redo()">↪</button>
        <button class="btn btn-reset" onclick="resetAll()">Nuovo</button>
        <button class="btn btn-export" onclick="exportJS()">Esporta</button>
        <button class="btn" style="background: var(--ios-gray);" onclick="document.getElementById('importFile').click()">Importa</button>
        <button class="btn" style="background: var(--ios-green);" onclick="shareApp()">Condividi</button>
        <input type="file" id="importFile" accept="*/*" style="display:none" onchange="importJS(this)">
    </div>
</div>

<div id="overlay" onclick="closeM()"></div>
<div id="modal">
    <div id="modal-scroll-area">
        <div id="modal-actions" class="modal-grid-btns"></div>
        <button class="mode-btn" style="width: 100%; background:#F2F2F7; color:#D00; margin-bottom: 10px;" onclick="clearCell()">SVUOTA CELLA</button>
        <div id="manual-input">
            <input type="text" id="mWord" placeholder="PAROLA" style="text-transform: uppercase;">
            <input type="text" id="mDef" placeholder="DEFINIZIONE">
            <button id="mAddBtn">INSERISCI MANUALMENTE</button>
        </div>
        <div id="sList"></div>
    </div>
</div>

<script>
    const S = 11;
    let data = Array(S).fill().map(() => Array(S).fill(null).map(() => ({ l: '', b: false, n: 0, mH: null, mV: null })));
    let cur = { x: 0, y: 0 };
    let undoStack = [], redoStack = [];

    window.addEventListener('load', () => {
        const saved = localStorage.getItem('crossword_index_data');
        if (saved) data = JSON.parse(saved);
        render();
    });

    function saveToLocal() { localStorage.setItem('crossword_index_data', JSON.stringify(data)); }
    function saveState() { undoStack.push(JSON.stringify(data)); redoStack = []; saveToLocal(); }

    function render() {
        updateNumbers();
        const g = document.getElementById('grid');
        g.innerHTML = '';
        data.forEach((row, y) => row.forEach((c, x) => {
            const d = document.createElement('div');
            d.className = 'cell' + (c.b ? ' black' : '');
            if (!c.b) {
                if (c.n > 0) d.innerHTML += `<span class="num">${c.n}</span>`;
                d.innerHTML += `<span>${c.l}</span>`;
            }
            d.onclick = () => { cur = {x, y}; openM(); };
            g.appendChild(d);
        }));
    }

    function updateNumbers() {
        data.forEach(r => r.forEach(c => c.n = 0));
        let count = 1;
        for (let y = 0; y < S; y++) {
            for (let x = 0; x < S; x++) {
                if (data[y][x].b) continue;
                let isH = (x === 0 || data[y][x-1].b) && (x + 1 < S && !data[y][x+1].b);
                let isV = (y === 0 || data[y-1][x].b) && (y + 1 < S && !data[y+1][x].b);
                if (isH || isV) data[y][x].n = count++;
            }
        }
    }

    function importJS(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const match = e.target.result.match(/parole:\s*\[([\s\S]*?)\]/);
            if (!match) throw new Error("Formato non valido");
            
            const jsonStr = "[" + match[1]
                .replace(/n:/g,'"n":').replace(/d:/g,'"d":')
                .replace(/x:/g,'"x":').replace(/y:/g,'"y":')
                .replace(/w:/g,'"w":').replace(/c:/g,'"c":')
                .replace(/'/g,'"') + "]";
            
            const parole = JSON.parse(jsonStr);
            saveState();

            // 1. Imposta TUTTA la griglia come NERA inizialmente
            data = Array(S).fill().map(() => Array(S).fill(null).map(() => ({ 
                l: '', b: true, n: 0, mH: null, mV: null 
            })));

            // 2. Per ogni parola importata, "accendi" le caselle rendendole bianche
            parole.forEach(p => {
                const word = p.w.toUpperCase();
                for (let i = 0; i < word.length; i++) {
                    let cx = p.d === 'H' ? p.x + i : p.x;
                    let cy = p.d === 'H' ? p.y : p.y + i;
                    
                    if (cx < S && cy < S) {
                        data[cy][cx].l = word[i];
                        data[cy][cx].b = false; // Diventa bianca perché c'è una lettera
                    }
                }
                // Salva i metadati della definizione nella prima cella della parola
                if (p.x < S && p.y < S) {
                    data[p.y][p.x][p.d === 'H' ? 'mH' : 'mV'] = { w: word, c: p.c };
                }
            });

            render();
            saveToLocal();
            alert("Importazione completata: griglia ricalcolata.");
        } catch (err) { 
            console.error(err);
            alert("Errore nel file importato."); 
        }
    };
    reader.readAsText(file);
    input.value = ""; 
}

    function openM() { 
        const cell = data[cur.y][cur.x];
        document.getElementById('modal-actions').innerHTML = `
            <button class="mode-btn btn-black-toggle" onclick="toggleBlack()">${cell.b ? 'BIANCA' : 'NERA'}</button>
            <button class="mode-btn btn-dir" onclick="findWords('H')">ORIZZ.</button>
            <button class="mode-btn btn-dir" onclick="findWords('V')">VERT.</button>
        `;
        document.getElementById('sList').innerHTML = '';
        document.getElementById('manual-input').style.display = 'none';
        document.getElementById('overlay').style.display = 'block'; 
        document.getElementById('modal').style.display = 'flex'; 
        document.getElementById('modal-scroll-area').scrollTop = 0;
    }
    
    function closeM() { document.getElementById('overlay').style.display = 'none'; document.getElementById('modal').style.display = 'none'; }
    function toggleBlack() { saveState(); data[cur.y][cur.x].b = !data[cur.y][cur.x].b; data[cur.y][cur.x].l = ''; render(); closeM(); }
    function clearCell() { saveState(); data[cur.y][cur.x].l = ''; data[cur.y][cur.x].b = false; render(); closeM(); }

    function findWords(dir) {
        if (data[cur.y][cur.x].b) { data[cur.y][cur.x].b = false; render(); }
        let sX = cur.x, sY = cur.y;
        while (dir === 'H' ? (sX > 0 && !data[sY][sX-1].b) : (sY > 0 && !data[sY-1][sX].b)) {
            if (dir === 'H') sX--; else sY--;
        }
        let pat = "", len = 0;
        for (let i = 0; (dir === 'H' ? sX + i : sY + i) < S; i++) {
            let tx = dir === 'H' ? sX + i : sX;
            let ty = dir === 'H' ? sY : sY + i;
            if (data[ty][tx].b) break;
            pat += data[ty][tx].l || ".";
            len++;
        }
        const list = document.getElementById('sList');
        list.innerHTML = "";
        document.getElementById('manual-input').style.display = 'flex';
        document.getElementById('mAddBtn').onclick = () => {
            let w = document.getElementById('mWord').value.toUpperCase().trim();
            let d = document.getElementById('mDef').value.trim();
            if (w.length >= 2 && w.length <= len) insertWord(w, d, dir, sX, sY, len);
        };
        if (window.glossarioData && window.glossarioData.voci) {
            const matches = window.glossarioData.voci.filter(v => {
                let p = v.parola.toUpperCase();
                if (p === "LIA") p = "LEA";
                if (p.length < 2 || p.length > len || ["IL","LO","LA","LE","GLI","UN","UNO","UNA"].includes(p)) return false;
                return new RegExp(`^${pat.substring(0, p.length)}$`, "i").test(p);
            }).sort((a,b) => b.parola.length - a.parola.length);
            matches.forEach(m => {
                const btn = document.createElement('button');
                btn.className = 's-item';
                let word = (m.parola.toUpperCase() === "LIA") ? "LEA" : m.parola.toUpperCase();
                btn.innerHTML = `<strong>${word}</strong><small>${m.def} ${m.rif?'('+m.rif+')':''}</small>`;
                btn.onclick = () => insertWord(word, m.def + (m.rif?' ('+m.rif+')':''), dir, sX, sY, len);
                list.appendChild(btn);
            });
        }
    }

    function insertWord(word, def, dir, x, y, maxLen) {
        saveState();
        if (word.length < maxLen) {
            let nx = dir === 'H' ? x + word.length : x;
            let ny = dir === 'H' ? y : y + word.length;
            if (nx < S && ny < S) data[ny][nx].b = true;
        }
        for (let i = 0; i < word.length; i++) {
            let cx = dir === 'H' ? x + i : x, cy = dir === 'H' ? y : y + i;
            data[cy][cx].l = word[i]; data[cy][cx].b = false;
        }
        data[y][x][dir === 'H' ? 'mH' : 'mV'] = { w: word, c: def };
        render(); closeM(); saveToLocal();
    }

    function exportJS() {
        const p = [];
        data.forEach((row, y) => row.forEach((c, x) => {
            if(c.mH) p.push({ n: c.n, d: 'H', x, y, w: c.mH.w, c: c.mH.c });
            if(c.mV) p.push({ n: c.n, d: 'V', x, y, w: c.mV.w, c: c.mV.c });
        }));
        let righe = p.map(i => ` {n:${i.n},d:'${i.d}',x:${i.x},y:${i.y},w:'${i.w}',c:'${i.c.replace(/'/g,"\\'")}'}`).join(',\n');
        const blob = new Blob([`const SCHEMI_BIBLICI = [{id:1,parole:[\n${righe}\n]}];`], { type: 'text/javascript' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'schema.js'; a.click();
    }

    function undo() { if (undoStack.length === 0) return; redoStack.push(JSON.stringify(data)); data = JSON.parse(undoStack.pop()); render(); saveToLocal(); }
    function redo() { if (redoStack.length === 0) return; undoStack.push(JSON.stringify(data)); data = JSON.parse(redoStack.pop()); render(); saveToLocal(); }
    function resetAll() { if(confirm("Cancellare tutto?")) { saveState(); data = Array(S).fill().map(() => Array(S).fill(null).map(() => ({ l: '', b: false, n: 0, mH: null, mV: null }))); localStorage.removeItem('crossword_index_data'); render(); } }
    function shareApp() { const url = 'https://asarritzu-boop.github.io/CruciGenerator/'; if (navigator.share) navigator.share({ title: 'Cruciverba Generator', url }); else { navigator.clipboard.writeText(url); alert("Copiato!"); } }
</script>
</body>
</html>
